- [ibm-sso](#ibm-sso)
  - [Getting Started](#getting-started)
  - [Usage](#usage)
  - [Sample](#sample)
  - [Deploy project(memo for developer)](#deploy-projectmemo-for-developer)

# ibm-sso

When using `SSO Self-Service Provisioner` for single sign-on, `ibm-sso` can make your work easier.

> Currently only supports fastapi applications.

## Getting Started

```bash
pip install ibm-sso
```

## Usage

1. Add `ibm-sso` to `requirements.txt` file

    ```bash
    ibm-sso==0.0.1
    ```

2. Install `ibm-sso` from `requirements.txt` file

    ```bash
    pipenv install -r requirements.txt
    ```

3. Set environment variables

    ```bash
    # Depending on the environment, modify the prefix `preprod`
    W3ID_CLIENT_ID=
    W3ID_CLIENT_SECRET=
    W3ID_ACCESS_TOKEN_URL=https://preprod.login.w3.ibm.com/oidc/endpoint/default/token
    W3ID_ACCESS_TOKEN_PARAMS=       # Set it if necessary, otherwise just comment it out or delete it.
    W3ID_AUTHORIZE_URL=https://preprod.login.w3.ibm.com/oidc/endpoint/default/authorize
    # W3ID_AUTHORIZE_PARAMS=        # Set it if necessary, otherwise just comment it out or delete it.
    W3ID_API_BASE_URL=https://preprod.login.w3.ibm.com/oidc/endpoint/default
    W3ID_USER_INFO_URL=https://preprod.login.w3.ibm.com/oidc/endpoint/default/userinfo
    W3ID_ENDPOINT_DISCOVERY=https://preprod.login.w3.ibm.com/oidc/endpoint/default/.well-known/openid-configuration
    W3ID_ENDPOINT_JWKS=https://preprod.login.w3.ibm.com/oidc/endpoint/default/jwks
    W3ID_ENDPOINT_INTROSPECT=https://preprod.login.w3.ibm.com/oidc/endpoint/default/introspect
    W3ID_ENDPOINT_REVOCATION=https://preprod.login.w3.ibm.com/v1.0/endpoint/default/revoke
    ```

4. Import `ibm-sso` in startup file

    ```python
    from starlette.middleware.sessions import SessionMiddleware

    app = FastAPI()

    @app.exception_handler(OAuthError)
    async def oauth_error_exception_handler(request, exc: OAuthError):
        return JSONResponse(content={'detail': exc.error}, status_code=status.HTTP_401_UNAUTHORIZED)

    app.add_middleware(SessionMiddleware, secret_key='Change Me to Random Secret!')

    app.include_router(authorize_router, prefix='/oauth2', tags=['Authorize API'])
    ```

5. Now, your application has added SSO authentication functionality.

## Sample

There is a sample in the `sample` directory that can be run directly. You can start from the sample to learn how to use ibm-sso.

The sample application uses pipenv as a virtual environment.

In addition, after the application is started, you can confirm the OpenAPI information through the following URL: [https://localhost:5000/docs](https://localhost:5000/docs)

> The SSL certificate used for testing can be generated by yourself, or you can directly use the certificate provided in the sample/ssl_local directory.

```bash
cd sample

pipenv shell

pipenv install -r requirements.txt

python app.py
```

## Deploy project(memo for developer)

```bash
# https://test.pypi.org/
expect interactive_deploy_test.expect

# https://pypi.org/
# expect interactive_deploy.expect
```
